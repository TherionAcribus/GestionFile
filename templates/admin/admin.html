{% extends '/admin/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div id="div_select_dashboard"
    hx-get="/admin/dashboard/display_select"
    hx-trigger="load, refresh_dashboard_select">
</div>


<div id="dashboard" class="container-fluid">
    <div id="sortable-dashboard" class="dashboard-flex">
        {% for dashboardcard in dashboardcards %}
            {% set template_name = 'admin/dashboard_load_' + dashboardcard.name + '.html' %}
            {% with dashboardcard = dashboardcard %}
                {% include template_name %}
            {% endwith %}
        {% endfor %}
    </div>
</div>



<script>
var sortableInstance = null;

function initializeSortable() {
    var dashboardEl = document.getElementById('sortable-dashboard');
    if (!dashboardEl) return;
    
    if (sortableInstance) {
        sortableInstance.destroy();
    }
    
    sortableInstance = new Sortable(dashboardEl, {
        handle: '.card-header',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: function (evt) {
            var order = [];
            document.querySelectorAll('#sortable-dashboard .dashboard-card').forEach(function (item, index) {
                var cardId = parseInt(item.id.replace('card-', ''));
                order.push({
                    id: cardId,
                    position: index + 1
                });
            });

            fetch('/admin/dashboard/save_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order: order })
            }).then(response => {
                if (response.ok) {
                    console.log('Ordre des cartes sauvegardé');
                } else {
                    console.error('Erreur lors de la sauvegarde de l\'ordre');
                    alert('Erreur lors de la sauvegarde de l\'ordre des cartes');
                }
            }).catch(error => {
                console.error('Erreur réseau:', error);
                alert('Erreur de connexion lors de la sauvegarde');
            });
        }
    });
}

document.addEventListener('DOMContentLoaded', function () {
    initializeSortable();
});

// Réinitialiser Sortable après mise à jour HTMX
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'sortable-dashboard') {
        initializeSortable();
    }
});

</script>


{% endblock %}

